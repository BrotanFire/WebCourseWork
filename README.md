## Аналитик

@shchelkanov

## Описание улучшения

Добавление в дебаг режим ВТС и АК поддержку ЕКАРТЫ.

## Плановая задача

Нет

## Release notes

Добавлена поддержка ЕКАРТ для дебаг-режима ВТС и АК.

## Причины внесения изменений

- Отдел тестирования нуждается в дебаг-режиме для тестирования проблем и доработок, связанных с ЕКАРТОЙ.
- Отсутствуют какие-либо возможности воспроизведения функционала, связанного с ЕКАРТОЙ, без ее физического воплощения.
- У отдела тестирования появится инструмент для виртуального тестирования функционала, связанного с ЕКАРТАМИ в ВТС и АК.

## Какой результат ожидает получить заказчик изменений

Дебаг режим с полной имитацией функционала ЕКАРТЫ.

## Требования

- Добавить в файл конфигурации ВТС и АК настройку(`<property name="UmEkartDebug">True</property>`) в блок `<Um>` для включения режима дебага ЕКАРТЫ. По умолчанию настройка должна иметь значение = `False`
- При запуске ВТС или АК с включенной настройкой(`<property name="UmEkartDebug">True</property>`) в рабочем каталоге должен создаться каталог(`FakeUmEkart`), содержащий файл(`UmEkartCard.xml`).
- После переключения ВТС или АК в дебаг-режим ЕКАРТЫ, должен поменяться и добавиться следующий функционал ЕКАРТЫ:
- Функционал успешной оплаты.\
Должен имитироваться сценарий реальной оплаты при помощи ЕКАРТЫ:
- Инициируется списание средств с ЕКАРТЫ
- Печать билета
- Запись билета и транзакций в ЛБД/СБД\
Списание средств с ЕКАРТЫ так же должно быть записано в файле(`UmEkartCard.xml`) в параметре `Balance`
- Функционал провальной оплаты.\
Должен происходить сценарий с ошибкой принтера и последующим возвратом средств на ЕКАРТУ:
- Инициируется списание средств с ЕКАРТЫ
- Происходит имитация ошибки принтера
- Осуществляется возврат средств на ЕКАРТУ
- Записывается информация о транзакциях в ЛБД/СБД.
- Функционал транспортной карты\
Должен имитироваться сценарий использования ЕКАРТЫ для применения льгот к поездке и последующая персонификация:
- Чтение льготного профиля
- Применение скидки по льготе
- запись персонификации в ЛБД/СБД\

Пример льготного профиля для тестирования по умолчанию:
- ФИО: Тестовый Тест Тестович
- Дата рождения: 01.01.1960
- Номер льготы: 3093 (Рег. льгота "Пенсионеры по старости Свердловской области")

- Файл(`UmEkartCard.xml`) должен содержать в себе настройки дебаг-режима:

| Название параметра | Описание |
|--------------------|----------|
| Номер карты (`UmEkartNumber`) | Задает значение номера ЕКАРТЫ. По умолчанию: 000000123 |
| Баланс карты (`Balance`) | Текущий баланс ЕКАРТЫ. По умолчанию: 1000,00 (руб.) |
| Статус в блэк-листе (`BlackList`) | Признак нахождения ЕКАРТЫ в листе блокировки. По умолчанию: `False` |
| ФИО держателя карты (`Owner`) | ФИО владельца карты, нужно для персонификации. Пользователь должен существовать в СБД. Все параметры которые описаны ниже должны принадлежать ему. По умолчанию: Тестовый Тест Тестович |
| Дата рождения (`BirthDay`) | Дата рождения владельца, карты нужно для персонификации. По умолчанию: 01.01.1960 |
| Номер льготы (`LgotNumber`)| Номер льготы владельца, карты нужно для персонификации. По умолчанию: 3093 |

<details><summary>Пример UmEkartCard.xml</summary>
[UmEkartCard.xml](/uploads/84b17e72fbc94626c2f5d5b61c04f90e/UmEkartCard.xml)
</details>

## Особые примечания
- В случае запуска ВТС или АК с одновременно включенными дебаг-режимами ЕКАРТЫ и карты Траектория выдать предупреждение о том, что эти два режима несовместимы и их функционал пересекается.

- Предусмотреть возможность вызова ошибки принтера как с реальным ККМ, так и с .txt.
### Сторонние сервисы

Не требуется

# Техническая часть

## Комментарии тимлида

{+заполняется инженером-постановщиком задачи+}

#### Релиз:

- [ ] release/20190520_master (МК-35)
- [ ] release/2 (ТС)
- [ ] release/5
- [ ] release/6
- [x] master

<details>
<summary>Где делать</summary>

#### Полигон:

- [ ] Все полигоны
- [ ] БайППК - Байкальская пригородная пассажирская компания
- [ ] БашППК - Башкортостанская пригородная
15:46


пассажирская компания
- [ ] ВВППК - Волго-Вятская пригородная пассажирская компания
- [ ] ВТП - Волгоградтранспригород
- [ ] ДЖД - Донецкая железная дорога
- [ ] ЗППК - Забайкальская пригородная пассажирская компания
- [ ] КППК - Калининградская пригородная пассажирская компания
- [ ] ПКС - Пассажирская компания "Сахалин"
- [ ] ППК - Пермская пригородная компания
- [ ] ППКЧ - Пригородная пассажирская компания "Черноземье"
- [ ] СамППК - Самарская пригородная пассажирская компания
- [ ] СарППК - Саратовская пригородная пассажирская компания
- [ ] СевППК - Северная пригородная пассажирская компания
- [ ] СЗППК - Северо-Западная пригородная пассажирская компания
- [ ] СКППК - Северо-Кавказская пригородная пассажирская компания
- [ ] Содружество - Пригородная пассажирская компания "Содружество"
- [ ] Сочи - Кубань Экспресс-Пригород
- [x] СПК - Свердловская пригородная компания
- [ ] ЭксППК - Пригородная пассажирская компания "Экспресс Приморья"
- [ ] ЮППК - Южная пригородная пассажирская компания

</details>
